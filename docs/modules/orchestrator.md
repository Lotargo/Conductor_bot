# Модуль Orchestrator

## Обзор

Модуль `Orchestrator` является центральным координирующим компонентом в системе Conductor. Его главная задача — **прослушивать уведомления с нескольких платформ одновременно**, управлять буферизацией данных и тайм-аутами, собирать контекст и передавать его в `Decision Engine` для принятия решений.

## Функциональность

Модуль спроектирован для параллельной обработки событий от разных мессенджеров.

Ключевые операции:
1.  **Параллельное прослушивание Kafka**: Запускает несколько потоков-потребителей, каждый из которых слушает свой топик (`KAFKA_TOPIC_WHATSAPP_NOTIFICATIONS`, `KAFKA_TOPIC_TELEGRAM_NOTIFICATIONS`).
2.  **Буферизация**: Сохраняет полученные "снимки" во временном, потокобезопасном буфере (`SCREENSHOT_BUFFER`), группируя их по `chat_id`.
3.  **Управление таймерами**: Для каждого нового `chat_id` запускает таймер (`ORCHESTRATOR_TIMEOUT`). Это позволяет собрать пакет данных для более контекстного принятия решений, а не реагировать на каждое событие мгновенно.
4.  **Обработка по тайм-ауту**: Когда таймер истекает, `Orchestrator` выполняет следующие действия:
    *   **Определяет платформу** по первому сообщению в буфере.
    *   Загружает манифест персоны и историю сообщений.
    *   Собирает все накопленные "снимки".
    *   Формирует запрос на принятие решения, **включая в него `platform`**.
5.  **Отправка в Decision Engine**: Отправляет сформированный запрос в топик Kafka `KAFKA_TOPIC_DECISIONS`.

## Логика работы с таймерами

-   При получении первого уведомления для `chat_id` запускается таймер.
-   Если приходит следующее уведомление для того же `chat_id` до истечения таймера, оно просто добавляется в буфер.
-   После истечения таймера все накопленные данные обрабатываются, и таймер для данного `chat_id` удаляется до следующего входящего уведомления.

## Формат исходящего сообщения (для Decision Engine)

Сообщение, отправляемое в `KAFKA_TOPIC_DECISIONS`, имеет следующую структуру:

```json
{
  "chat_id": "some_unique_chat_id",
  "platform": "telegram", // или "whatsapp"
  "persona_manifest": {
    "persona_name": "corporate_assistant",
    "system_prompt": "...",
    "rules": {}
  },
  "rag_context": "история сообщений...",
  "screenshots": [
    "base64_encoded_screenshot_1",
    "base64_encoded_screenshot_2"
  ]
}
```