# Модуль Orchestrator

## Обзор

Модуль `Orchestrator` является центральным координирующим компонентом в системе Conductor. Он прослушивает уведомления о снимках экрана из Kafka, управляет буферизацией и тайм-аутами, собирает необходимые данные и передает их в `Decision Engine` для принятия решений.

## Функциональность

Основная задача модуля — управлять потоком данных и координировать взаимодействие между различными частями системы.

Ключевые операции:
1.  **Прослушивание Kafka**: Потребляет сообщения из топика `KAFKA_TOPIC_NOTIFICATIONS`, куда `Screenshotter` отправляет данные о снимках экрана.
2.  **Буферизация**: Сохраняет полученные снимки экрана во временном буфере (`SCREENSHOT_BUFFER`), группируя их по `chat_id`.
3.  **Управление таймерами**: Для каждого нового `chat_id` запускает таймер (`ORCHESTRATOR_TIMEOUT`). Если в течение этого времени приходят новые снимки для того же чата, они просто добавляются в буфер. Таймер гарантирует, что система не будет реагировать на каждое событие мгновенно, а соберет пакет данных для более контекстного принятия решений.
4.  **Обработка по тайм-ауту**: Когда таймер истекает, `Orchestrator` выполняет следующие действия:
    *   Загружает манифест персоны (правила и системные промпты).
    *   Получает историю сообщений из RAG-базы данных (`MockRAGDatabase`).
    *   Собирает все накопленные снимки экрана из буфера.
    *   Формирует запрос на принятие решения.
5.  **Отправка в Decision Engine**: Отправляет сформированный запрос в топик Kafka `KAFKA_TOPIC_DECISIONS`.

## Логика работы с таймерами

-   При получении первого уведомления для `chat_id` запускается таймер.
-   Если приходит следующее уведомление для того же `chat_id` до истечения таймера, таймер не перезапускается, а снимок просто добавляется в буфер.
-   После истечения таймера все накопленные данные обрабатываются, и таймер для данного `chat_id` удаляется до следующего входящего уведомления.

## Формат исходящего сообщения (для Decision Engine)

Сообщение, отправляемое в `KAFKA_TOPIC_DECISIONS`, имеет следующую структуру:

```json
{
  "chat_id": "some_unique_chat_id",
  "persona_manifest": {
    "persona_name": "corporate_assistant",
    "system_prompt": "...",
    "rules": {}
  },
  "rag_context": [
    "история сообщений..."
  ],
  "screenshots": [
    "base64_encoded_screenshot_1",
    "base64_encoded_screenshot_2"
  ]
}
```