<svg width="900" height="750" xmlns="http://www.w3.org/2000/svg" style="background-color: #0d1117; border-radius: 8px;">
    <!-- Sequence Diagram: Stimulus Processing (Final Polished Version 2.0) -->

    <defs>
        <style>
            .participant-text { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 14px; font-weight: 600; fill: #e6edf3; text-anchor: middle; }
            .arrow-text { font-family: sans-serif; font-size: 13px; fill: #c9d1d9; dominant-baseline: central; }
            .code-text { font-family: 'Roboto Mono', monospace; fill: #79c0ff; }
        </style>
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
            <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
    </defs>

    <!-- Участники и Линии жизни -->
    <g>
        <!-- Клиент -->
        <rect x="50" y="30" width="150" height="50" rx="6" fill="#161b22" stroke="#388bfd" stroke-width="2"/>
        <text y="55" class="participant-text"><tspan x="125">Клиент</tspan><tspan x="125" dy="1.2em" style="font-size:11px; fill:#8b949e;">(напр., LLM-парсер)</tspan></text>
        <line x1="125" y1="80" x2="125" y2="700" stroke="#30363d" stroke-width="2" stroke-dasharray="5 5"/>
        <!-- API -->
        <rect x="275" y="30" width="150" height="50" rx="6" fill="#161b22" stroke="#a371f7" stroke-width="2"/>
        <text x="350" y="55" class="participant-text">API (FastAPI)</text>
        <line x1="350" y1="80" x2="350" y2="700" stroke="#30363d" stroke-width="2" stroke-dasharray="5 5"/>
        <!-- Ядро -->
        <rect x="500" y="30" width="150" height="50" rx="6" fill="#161b22" stroke="#30a14e" stroke-width="2"/>
        <text x="575" y="55" class="participant-text">Ядро Движка</text>
        <line x1="575" y1="80" x2="575" y2="700" stroke="#30363d" stroke-width="2" stroke-dasharray="5 5"/>
        <!-- База данных -->
        <rect x="725" y="30" width="150" height="50" rx="6" fill="#161b22" stroke="#6e7681" stroke-width="2"/>
        <text y="55" class="participant-text"><tspan x="800">База данных</tspan><tspan x="800" dy="1.2em" style="font-size:11px; fill:#8b949e;">(SQLite)</tspan></text>
        <line x1="800" y1="80" x2="800" y2="700" stroke="#30363d" stroke-width="2" stroke-dasharray="5 5"/>
    </g>
    
    <!-- Активации -->
    <g fill-opacity="0.8">
        <rect x="345" y="120" width="10" height="560" rx="3" fill="#a371f7" />
        <rect x="570" y="200" width="10" height="380" rx="3" fill="#30a14e" />
        <rect x="795" y="360" width="10" height="80" rx="3" fill="#6e7681" />
    </g>

    <!-- Статичные стрелки -->
    <g stroke="#c9d1d9" stroke-width="2" fill="none">
        <path d="M 135,120 L 345,120"/>
        <path d="M 355,200 L 570,200"/>
        
        <!-- Исправленная петля: разделена на сплошную и пунктирную части -->
        <path d="M 580,260 L 650,260 L 650,300"/> <!-- Сплошная часть (вызов) -->
        <path d="M 650,300 L 580,300" stroke-dasharray="8 4"/> <!-- Пунктирная часть (ответ) -->
        
        <path d="M 580,360 L 795,360"/>
        <path d="M 795,440 L 580,440" stroke-dasharray="8 4"/>
        <path d="M 570,580 L 355,580" stroke-dasharray="8 4"/>
        <path d="M 345,680 L 135,680" stroke-dasharray="8 4"/>
    </g>

    <!-- Текстовый слой -->
    <g>
        <text x="240" y="110" class="arrow-text" text-anchor="middle">POST /stimulus (бинарные данные)</text>
        <text x="462" y="190" class="arrow-text" text-anchor="middle">Вызывает <tspan class="code-text">`process_stimulus()`</tspan></text>
        <text x="660" y="272" class="arrow-text" text-anchor="start">
            <tspan>Обновляет</tspan>
            <tspan x="660" dy="1.4em" class="code-text">EmotionalState</tspan>
        </text>
        <text x="687" y="350" class="arrow-text" text-anchor="middle">Записывает изменения в History</text>
        <text x="687" y="460" class="arrow-text" text-anchor="middle">Подтверждает запись</text>
        <text x="462" y="570" class="arrow-text" text-anchor="middle">Возвращает успех</text>
        <text x="240" y="670" class="arrow-text" text-anchor="middle">Отвечает <tspan class="code-text">`204 No Content`</tspan></text>
    </g>
    
    <!-- Анимационный слой -->
    <g filter="url(#glow)">
        <circle r="4" fill="#388bfd"><animateMotion dur="2s" begin="0s" repeatCount="indefinite" path="M 135,120 L 345,120"/></circle>
        <circle r="4" fill="#a371f7"><animateMotion dur="2s" begin="0.5s" repeatCount="indefinite" path="M 355,200 L 570,200"/></circle>
        <circle r="4" fill="#30a14e"><animateMotion dur="1.5s" begin="1s" repeatCount="indefinite" path="M 580,260 L 650,260 L 650,300 L 580,300"/></circle>
        <circle r="4" fill="#30a14e"><animateMotion dur="2s" begin="1.5s" repeatCount="indefinite" path="M 580,360 L 795,360"/></circle>
        <circle r="3" fill="#6e7681"><animateMotion dur="2s" begin="2s" repeatCount="indefinite" path="M 795,440 L 580,440"/></circle>
        <circle r="4" fill="#30a14e"><animateMotion dur="2.5s" begin="2.5s" repeatCount="indefinite" path="M 570,580 L 355,580"/></circle>
        <circle r="4" fill="#a371f7"><animateMotion dur="2.5s" begin="3s" repeatCount="indefinite" path="M 345,680 L 135,680"/></circle>
    </g>
</svg>
