# Руководство по Интеграции и Продвинутые Функции

Это руководство описывает, как эффективно использовать ключевые функции Sentio Engine для создания глубоких и реалистичных AI-личностей.

## 1. Паттерн "Agent Protocol": Надежное Обновление Состояния

Чтобы сделать взаимодействие между LLM-агентом и `Sentio Engine` максимально надежным, используйте эндпоинт `POST /process_agent_text`.

Он решает важную проблему: как агенту сообщить о своем эмоциональном состоянии, чтобы `Sentio` не парсил случайные слова из ответа пользователя, а реагировал только на четко выраженное намерение.

### Как это работает:

1.  **Агент формирует ответ с тегом.** После генерации ответа для пользователя, агент добавляет в конец своего полного ответа специальный блок-тег `[SENTIO_EMO_STATE]`, внутри которого находится JSON с его "сухим" эмоциональным состоянием.
2.  **Приложение отправляет полный текст в `Sentio`**. Весь текст, включая тег, отправляется на эндпоинт `/process_agent_text`.
3.  **`Sentio` парсит только тег**. Движок ищет только блок `[SENTIO_EMO_STATE]...[/SENTIO_EMO_STATE]` и игнорирует весь остальной текст.

### Пример

Агент хочет сказать пользователю "Все будет хорошо" и сообщить `Sentio` о своем состоянии.

**Полный текст, отправляемый на `POST /process_agent_text`:**
```json
{
  "text": "Все будет хорошо. Я здесь, чтобы помочь.\n\n[SENTIO_EMO_STATE]\n{\n  \"доверие\": 0.7,\n  \"радость\": 0.4\n}\n[/SENTIO_EMO_STATE]"
}
```

`Sentio Engine` проигнорирует фразу "Все будет хорошо" и обработает только `{"доверие": 0.7, "радость": 0.4}`. Этот паттерн превращает `Sentio Engine` в надежный "инструмент" для агентов, работающих по `ReAct` и схожим паттернам.

### Гибкость Парсера

Ключевой особенностью парсера является то, что он **не ожидает** получения полного списка всех 8 эмоций. Он спроектирован для эффективной работы с частичными данными:

-   **Обрабатываются только переданные эмоции:** Если агент присылает `{"злость": 0.8}`, то движок обновит интенсивность *только* для злости.
-   **Остальные эмоции не изменяются:** Все остальные эмоции, не упомянутые в запросе, остаются на своих текущих уровнях и продолжают естественный процесс "затухания" (`decay`).

## 2. Симуляция Жизни: Время-зависимое Затухание

Ключевой аспект реализма `Sentio Engine` — это его способность симулировать течение времени. Эмоциональное состояние агента не "заморожено" между взаимодействиями. Оно продолжает меняться, стремясь к своему базовому уровню, даже если сервер выключен.

### Как это работает:

1.  **Привязка к Реальному Времени:** Движок хранит в базе данных временную метку (`timestamp`) последнего обновления своего состояния.
2.  **Синхронизация при Активности:** Каждый раз, когда к движку обращаются (через `process_stimulus` или `get_report`), он первым делом выполняет "синхронизацию":
    *   Он проверяет, сколько реального времени прошло с момента последнего обновления.
    *   Рассчитывает, сколько "шагов" симуляции (тиков) нужно выполнить, чтобы "догнать" текущее время. Длительность одного шага настраивается в `engine_settings.json`.
    *   Применяет формулу затухания эмоций нужное количество раз.
3.  **Непрерывность Состояния:** Этот механизм гарантирует, что состояние агента всегда актуально. Если агент вчера был зол на пользователя (`"злость": 0.9`), а сегодня пользователь снова начинает диалог, `Sentio Engine` сначала симулирует прошедшие 24 часа. Злость за это время значительно угаснет, и агент встретит пользователя уже в гораздо более спокойном настроении.

## 3. Взаимодействие Эмоций: Механизм Доминантности

Для еще большего реализма, эмоции в `Sentio Engine` не существуют в вакууме. Они взаимодействуют друг с другом на основе концепции **полярных противоположностей** из модели Роберта Плутчика.

### Как это работает:

1.  **Подавление Слабейшего:** После каждого обновления состояния (из-за стимула или шага времени) движок запускает механизм доминантности.
2.  **Сравнение в Парах:** Для каждой пары противоположных эмоций (например, "страх" и "злость") движок сравнивает их текущие интенсивности.
3.  **Применение Эффекта:** Более сильная эмоция в паре "подавляет" более слабую, уменьшая ее интенсивность. Сила этого подавления настраивается параметром `dominance_factor` в `engine_settings.json`.

### Пример из Практики:

-   Предположим, агент сильно напуган (`"страх": 0.9`), но получает небольшой стимул злости (`"злость": 0.2`).
-   Механизм доминантности увидит, что `Страх > Злость`. В результате интенсивность злости будет значительно уменьшена (возможно, даже до нуля).
-   Это не позволяет агенту одновременно испытывать две конфликтующие эмоции с высокой интенсивностью, что делает его состояние более стабильным и правдоподобным.

## 4. Анализ Прошлого: Движок Комплексных Состояний ("Чувств")

`Sentio Engine` способен не только отслеживать сиюминутные *эмоции*, но и выявлять долгосрочные, устойчивые *чувства* или *состояния*.

### Как это работает:

1.  **"Рецепты" Чувств:** В файле `feelings.json` определены "рецепты" для различных состояний. Каждый рецепт — это набор условий, которые должны выполняться в течение определенного времени.
    *   **Пример "рецепта" для депрессивного состояния:**
        *   **Длительность:** 336 часов (2 недели).
        *   **Условие 1:** Интенсивность `грусти` должна быть постоянно `>= 0.7`.
        *   **Условие 2:** Интенсивность `радости` должна быть постоянно `<= 0.2`.

2.  **Анализ Истории и Включение в Отчет:** При запросе `/report`, движок анализирует историю. Если условия для какого-либо состояния выполняются, его название добавляется в поле `complex_states` в ответе.
    *   **Пример ответа:** `{"emotional_state": {...}, "complex_states": ["депрессивное состояние"]}`.

### Практическое Применение для LLM:

Эта функция дает LLM-генератору невероятно мощный контекст.
-   Если `complex_states` содержит `"депрессивное состояние"`, системный промпт может быть обновлен: `"Ты — эмпатичный друг. Твое текущее настроение: грустное. Внимание: ты находишься в затяжном депрессивном состоянии. Твои ответы должны быть осторожными, поддерживающими, но лишенными ложного оптимизма."`
-   Это позволяет AI-агенту сохранять последовательность характера на протяжении многих дней и недель, что является ключевым шагом к созданию по-настояшему "живых" виртуальных личностей.

---
**Далее:** [Кэширование](./06_caching_strategy.md)
